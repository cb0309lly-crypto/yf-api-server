# 订单金额精度修复指南

## 问题现象

提交订单时出现以下错误：

```
QueryFailedError: invalid input syntax for type integer: "222.4"
```

## 原因分析

数据库 `yf_db_order` 表的 `order_total` 字段类型为 `integer`，无法存储带小数的金额。

## 修复步骤

### 第一步：执行数据库迁移

在 `yf-api-server` 目录下执行：

```bash
node migrations/run-order-total-fix.js
```

执行成功后会看到：

```
连接数据库...
数据库连接成功
执行迁移脚本...
✓ 迁移执行成功！

验证字段类型...
字段信息：
  - 字段名: order_total
  - 数据类型: numeric
  - 精度: 10
  - 小数位: 2

✓ 字段类型验证通过！

数据库连接已关闭
```

### 第二步：重启应用

```bash
# 如果使用 pm2
pm2 restart yf-api-server

# 或者直接重启
npm run start:dev
```

### 第三步：测试订单创建

使用小程序或 API 测试工具提交订单，验证金额计算正确。

## 已修复的内容

### 1. 数据库表结构
- `yf_db_order.order_total`: `integer` → `decimal(10,2)`

### 2. 实体定义
文件：`src/entity/order.ts`

```typescript
@Column({
  name: 'order_total',
  type: 'decimal',
  precision: 10,
  scale: 2,
  default: 0.0,
  nullable: true,
})
orderTotal: number;
```

### 3. 服务层精度处理
文件：`src/order/order.service.ts`

新增方法：
```typescript
private roundToTwoDecimals(value: number): number {
  return Math.round(value * 100) / 100;
}
```

所有金额计算都使用此方法确保精度：
- `commitPay()` - 订单提交
- `getSettleDetail()` - 结算详情
- `addOrder()` - 创建订单

## 验证方法

### 1. 数据库验证

```sql
-- 查看字段类型
SELECT 
  column_name, 
  data_type, 
  numeric_precision, 
  numeric_scale 
FROM information_schema.columns 
WHERE table_name = 'yf_db_order' 
  AND column_name = 'order_total';

-- 查看现有订单数据
SELECT no, name, order_total, order_status 
FROM yf_db_order 
ORDER BY created_at DESC 
LIMIT 10;
```

### 2. API 测试

使用 Postman 或其他工具测试 `/order/commit-pay` 接口：

```json
{
  "goodsRequestList": [
    {
      "spuId": "product-no-123",
      "quantity": 3,
      "price": 74.13,
      "goodsName": "测试商品"
    }
  ],
  "userAddressReq": {
    "name": "测试用户",
    "phone": "13800138000",
    "provinceName": "浙江省",
    "cityName": "杭州市",
    "districtName": "西湖区",
    "detailAddress": "文三路123号"
  }
}
```

预期结果：
- 订单创建成功
- `order_total` = 222.39（74.13 × 3）
- 金额保留2位小数

## 回滚方案

如果需要回滚（不推荐），执行：

```bash
node migrations/rollback-order-total-fix.js
```

**注意**：回滚会导致已有的小数金额被截断为整数，可能造成数据丢失！

## 相关文件

- 迁移脚本：`migrations/fix-order-total-decimal.sql`
- 执行脚本：`migrations/run-order-total-fix.js`
- 实体定义：`src/entity/order.ts`
- 服务逻辑：`src/order/order.service.ts`
- 详细文档：`migrations/README-order-total-fix.md`

## 常见问题

### Q1: 迁移失败怎么办？

检查数据库连接配置：
- 确认 `.env.development` 中的数据库配置正确
- 确认数据库服务正常运行
- 确认有足够的权限修改表结构

### Q2: 现有订单数据会丢失吗？

不会。整数金额会自动转换为 decimal 类型：
- `100` → `100.00`
- `0` → `0.00`

### Q3: 为什么选择 decimal(10,2)？

- `10` 位总长度：支持最大 99,999,999.99（近1亿）
- `2` 位小数：满足人民币分的精度要求
- 避免浮点数精度问题

### Q4: 其他金额字段需要修改吗？

不需要。以下字段已经是 decimal 类型：
- `yf_db_order_item.unit_price`
- `yf_db_order_item.total_price`
- `yf_db_order_item.final_price`
- `yf_db_payment.amount`
- `yf_db_product.price`

## 技术支持

如有问题，请联系开发团队或查看项目文档。
