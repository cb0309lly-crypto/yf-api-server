# 订单完成后清空购物车功能说明

## 功能概述

当用户成功创建订单后，系统会自动将购物车中对应的商品标记为"已购买"状态，从而在购物车列表中不再显示这些商品。

## 实现方式

### 1. 购物车状态管理

购物车商品有三种状态（`CartItemStatus`）：
- `ACTIVE` - 活跃状态（显示在购物车中）
- `REMOVED` - 已移除（用户手动删除）
- `PURCHASED` - 已购买（订单创建后自动标记）

### 2. 新增方法

在 `CartService` 中新增了 `markAsPurchased` 方法：

```typescript
markAsPurchased(userNo: string, productNo: string) {
  return this.cartRepository.update(
    { userNo, productNo, status: CartItemStatus.ACTIVE },
    { status: CartItemStatus.PURCHASED },
  );
}
```

### 3. 订单服务集成

#### 模块依赖
在 `OrderModule` 中导入 `CartModule`：

```typescript
@Module({
  imports: [
    // ... 其他模块
    CartModule,
  ],
  // ...
})
export class OrderModule {}
```

#### 服务注入
在 `OrderService` 构造函数中注入 `CartService`：

```typescript
constructor(
  // ... 其他依赖
  private readonly cartService: CartService,
  // ...
) {}
```

### 4. 自动清理逻辑

#### commitPay 方法（小程序订单）

在订单创建成功并提交事务后：

```typescript
await queryRunner.commitTransaction();

// 订单创建成功后，清空购物车中对应的商品
if (userNo) {
  try {
    for (const item of pendingItems) {
      if (item.productNo) {
        await this.cartService.markAsPurchased(userNo, item.productNo);
      }
    }
    this.logger.log(`购物车清理成功: 用户 ${userNo}, 商品数量 ${pendingItems.length}`);
  } catch (error) {
    this.logger.warn(`购物车清理失败: ${error.message}`);
  }
}
```

#### addOrder 方法（后台订单）

在订单创建完成后：

```typescript
// 订单创建成功后，清空购物车中对应的商品
try {
  for (const item of data.items) {
    if (item.productNo) {
      await this.cartService.markAsPurchased(data.userNo, item.productNo);
    }
  }
  this.logger.log(`购物车清理成功: 用户 ${data.userNo}, 商品数量 ${data.items.length}`);
} catch (error) {
  this.logger.warn(`购物车清理失败: ${error.message}`);
}
```

## 设计特点

### 1. 容错性
- 购物车清理失败不会影响订单创建
- 使用 try-catch 捕获异常，只记录日志
- 确保订单创建的核心流程不受影响

### 2. 状态区分
- 使用 `PURCHASED` 状态而非 `REMOVED`
- 便于后续数据分析和用户行为追踪
- 可以区分用户主动删除和购买后自动清理

### 3. 精确匹配
- 按 `userNo` 和 `productNo` 精确匹配
- 只更新 `ACTIVE` 状态的商品
- 避免误操作已删除或已购买的商品

### 4. 日志记录
- 成功时记录清理的商品数量
- 失败时记录警告日志
- 便于问题排查和监控

## 业务流程

```
用户提交订单
    ↓
验证商品和库存
    ↓
扣减库存
    ↓
创建订单记录
    ↓
创建订单项
    ↓
创建支付记录
    ↓
提交事务 ✓
    ↓
清理购物车（标记为已购买）
    ↓
返回订单信息
```

## 数据库影响

### 更新语句
```sql
UPDATE yf_db_cart 
SET status = 'purchased' 
WHERE user_no = ? 
  AND product_no = ? 
  AND status = 'active';
```

### 查询影响
获取用户购物车时，只查询 `status = 'active'` 的商品：

```typescript
const cartItems = await this.cartRepository.find({
  where: { userNo: userId, status: CartItemStatus.ACTIVE },
  relations: ['product'],
  order: { addedAt: 'DESC' },
});
```

## 测试场景

### 场景1：正常订单创建
1. 用户购物车有商品 A、B、C
2. 用户选择商品 A、B 创建订单
3. 订单创建成功
4. 购物车中商品 A、B 状态变为 `purchased`
5. 购物车列表只显示商品 C

### 场景2：部分商品下单
1. 用户购物车有商品 A、B、C
2. 用户只选择商品 A 创建订单
3. 订单创建成功
4. 购物车中商品 A 状态变为 `purchased`
5. 购物车列表显示商品 B、C

### 场景3：重复购买
1. 用户购物车有商品 A（已购买）
2. 用户再次添加商品 A 到购物车（新记录）
3. 用户创建订单
4. 新的商品 A 记录状态变为 `purchased`
5. 旧的商品 A 记录保持 `purchased` 状态

### 场景4：清理失败
1. 订单创建成功
2. 购物车清理时数据库连接失败
3. 记录警告日志
4. 订单仍然有效
5. 用户可以手动删除购物车商品

## 监控指标

建议监控以下指标：
- 购物车清理成功率
- 购物车清理失败次数
- 购物车清理平均耗时
- 已购买状态商品数量

## 后续优化建议

1. **批量更新**：如果订单商品较多，可以考虑批量更新购物车状态
2. **异步处理**：将购物车清理放入消息队列异步处理
3. **定期清理**：定期清理长期处于 `purchased` 状态的记录
4. **用户通知**：可以在清理后给用户发送通知

## 相关文件

- 购物车服务：`src/cart/cart.service.ts`
- 购物车实体：`src/entity/cart.ts`
- 订单服务：`src/order/order.service.ts`
- 订单模块：`src/order/order.module.ts`
